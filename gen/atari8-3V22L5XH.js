import{a as nt}from"./chunk-YZQ2OPTV.js";import{C as at,J as F,g as $,k as tt,q as et,s as st,u as it,z as rt}from"./chunk-3NXXB3IA.js";import{$ as R,J as A,O as f,U as g,V as s,W as Z,Y as O,a as S,da as J,g as p,q as u}from"./chunk-G7IBJTLG.js";import"./chunk-5XVCUSSZ.js";var Ct=[0,26,18,10],vt=[0,26+64,18+80,10+96],_=0,Dt=1,N=2,U=3,Kt=4,Lt=5,kt=7,wt=9,M=10,Vt=11,Ft=12,Nt=13,ht=14,Ut=15,P=15;var Yt=[0,0,8,10,8,16,8,16,8,4,4,2,1,2,1,1],Bt=[0,0,2,2,2,2,4,4,8,4,4,4,4,2,2,2],Ht=[0,0,0,0,0,1,0,1,0,0,2,1,0,0,0,0],ot=[0,0,1,1,2,2,2,2,8,4,4,2,2,2,2,1],T=class{constructor(t,e){this.regs=new Uint8Array(16);this.dma_enabled=!1;this.dliop=0;this.mode=0;this.jmp=!1;this.lms=!1;this.dlarg_lo=0;this.dlarg_hi=0;this.period=0;this.scanaddr=0;this.startaddr=0;this.pfbyte=0;this.ch=0;this.linesleft=0;this.yofs=0;this.v=0;this.h=0;this.linebuf=new Uint8Array(48);this.dmaclock=0;this.dmaidx=0;this.output=0;this.dramrefresh=!1;this.vscroll=0;this.read=t,this.nmi=e}reset(){this.regs.fill(0),this.regs[ht]=0,this.regs[P]=127,this.regs[Ft]=0,this.regs[Nt]=255,this.setReg(_,0),this.h=this.v=0,this.startaddr=this.scanaddr=0,this.dmaclock=0}saveState(){return u(0,{},this)}loadState(t){u(0,this,t),this.setReg(_,t.regs[_])}static stateToLongString(t){let e="";return e+="H: "+S(t.h,3)+"  V: "+S(t.v,3)+`
`,e+="DLIOp: "+p(t.dliop,2)+"  Lines: "+t.yofs+"/"+t.linesleft,e+="   DMA "+(t.dma_enabled?"ON ":"off")+`
`,e+="Addr: "+p(t.scanaddr,4)+`
`,e+=g(t.regs,0,16).replace("$00","Regs"),e}setReg(t,e){switch(t){case M:this.regs[M]=255;return;case Ut:this.regs[P]=31;return}this.regs[t]=e}readReg(t){switch(t){case P:return this.regs[t];case Vt:return this.v>>1;default:return 255}}processDLIEntry(){this.mode==0?this.linesleft=(this.dliop>>4)+1:(this.linesleft=Yt[this.mode],this.period=Bt[this.mode],this.jmp?(this.regs[N]=this.dlarg_lo,this.regs[U]=this.dlarg_hi,this.mode=this.period=0,this.dliop&64&&(this.linesleft=1,this.dma_enabled=!1)):this.lms&&(this.scanaddr=this.dlarg_lo+(this.dlarg_hi<<8)),this.startaddr=this.scanaddr);let t=this.regs[_]&3,e=this.dliop&16?(this.regs[Kt]&15)>>1:0;this.dliop&16&&t<3&&t++,this.left=Ct[t]+e,this.right=vt[t]+e;let i=this.regs[Lt]&15;this.dliop&32^this.vscroll&&(this.vscroll?this.linesleft-=i:(this.linesleft-=i,this.yofs+=i),this.vscroll^=32)}nextLine(){this.linesleft>0&&(this.linesleft--,this.yofs++,this.mode>=8&&this.linesleft&&(this.scanaddr=this.startaddr))}triggerNMI(t){this.regs[P]=t|31,this.regs[ht]&t&&this.nmi()}nextInsn(){let t=this.regs[N]+(this.regs[U]<<8),e=this.read(t);return t=t+1&1023|t&~1023,this.regs[N]=t&255,this.regs[U]=t>>8,e}nextScreen(){let t=this.read(this.scanaddr);return this.scanaddr=this.scanaddr+1&4095|this.scanaddr&~4095,t}dlDMAEnabled(){return this.regs[_]&32}isVisibleScanline(){return this.v>=8&&this.v<248}isPlayfieldDMAEnabled(){return this.dma_enabled&&!this.linesleft}isPlayerDMAEnabled(){return this.dma_enabled&&this.regs[_]&8}isMissileDMAEnabled(){return this.dma_enabled&&this.regs[_]&12}clockPulse(){let t=this.regs[M]!=0;if(!this.isVisibleScanline())this.doVBlank();else{switch(this.h){case 0:this.isMissileDMAEnabled()&&(this.doPlayerMissileDMA(3),t=!0);break;case 1:if(this.isPlayfieldDMAEnabled()){let e=this.nextInsn();this.jmp=(e&~64)==1,this.lms=(e&64)!=0&&(e&15)!=0,this.mode=e&15,this.dliop=e,this.yofs=0,t=!0}break;case 2:case 3:case 4:case 5:this.isPlayerDMAEnabled()&&(this.doPlayerMissileDMA(this.h+2),t=!0);break;case 6:case 7:this.isPlayfieldDMAEnabled()&&this.yofs==0&&(this.jmp||this.lms)&&(this.h==6&&(this.dlarg_lo=this.nextInsn()),this.h==7&&(this.dlarg_hi=this.nextInsn()),t=!0);break;case 8:this.yofs==0&&this.processDLIEntry(),this.dliop&128&&this.linesleft==1&&this.triggerNMI(128);break;case 9:break;case 111:this.dma_enabled&&this.nextLine(),++this.v;break}if(this.output=0,this.mode>=2&&this.period){let e=this.h<106;this.dmaclock<<=1,this.dmaclock&1<<this.period&&(this.dmaclock|=1),this.h==this.left&&(this.dmaclock|=1,this.dmaidx=0),this.h==this.right&&(this.dmaclock&=~1,this.dmaidx++),this.dmaclock&1?(this.mode<8&&this.yofs==0&&(this.linebuf[this.dmaidx]=this.nextScreen(),t=e),this.dmaidx++):this.dmaclock&8&&(this.ch=this.linebuf[this.dmaidx-4/this.period],this.readBitmapData(),t=e),this.output=this.h>=this.left+3&&this.h<=this.right+2?4:0}}return(this.h<19||this.h>102)&&(this.output=2),this.incHorizCounter(),!t&&this.dramrefresh&&(this.dramrefresh=!1,t=!0),t}incHorizCounter(){switch(++this.h,this.h){case 25:case 25+4*1:case 25+4*2:case 25+4*3:case 25+4*4:case 25+4*5:case 25+4*6:case 25+4*7:case 25+4*8:this.dramrefresh=!0;break;case 103:this.regs[M]=0;break;case 114:this.h=0;break}}doVBlank(){this.linesleft=this.mode=this.period=0,this.h==111&&this.v++,this.v==248&&this.h==0&&this.triggerNMI(64),this.v==262&&this.h==112&&(this.v=0),this.v==7&&this.h==113&&(this.dma_enabled=this.dlDMAEnabled()!=0),this.output=2}doPlayerMissileDMA(t){let e=this.regs[_]&16,i=this.regs[kt]<<8;e?(i&=63488,i|=t<<8,i|=this.v&255):(i&=64512,i|=t<<7,i|=this.v>>1),this.read(i)}readBitmapData(){let t=this.mode;if(t<8){let e=this.ch,i=this.yofs>>Ht[this.mode],a=i&7,m=this.regs[wt];(t&14)==6?(e&=63,m&=254):(e&=127,m&=252);let x=(e<<3)+(m<<8);if((t&14)==2){let V=this.regs[Dt],X=t==3&&(e&96)==96;V&4?this.pfbyte=this.read(x+(a^7)):this.pfbyte=this.read(x+a),X&&i<2&&(this.pfbyte=0),!X&&i>7&&(this.pfbyte=0),this.ch&128&&(V&1&&(this.pfbyte=0),V&2&&(this.pfbyte^=255))}else this.pfbyte=this.read(x+a)}else this.pfbyte=this.nextScreen()}shiftout(){if(this.output==4)switch(this.mode){case 2:case 3:case 15:{let t=this.pfbyte>>7&1;return this.pfbyte<<=1,t?8:6}case 6:case 7:{let t=this.pfbyte>>7&1;return this.pfbyte<<=1,t?(this.ch>>6)+4:0}case 9:case 11:case 12:{let t=this.pfbyte>>7&1;return this.pfbyte<<=1,t?4:0}case 4:case 5:case 8:case 10:case 13:case 14:{let t=this.pfbyte>>6&3;return this.pfbyte<<=2,[0,4,5,6][t]}}return this.output}};var Qt=0;var jt=8,zt=12,ct=13,lt=17,Gt=18,qt=22,Wt=23,Xt=24,Zt=25,Jt=26,$t=27;var dt=29,te=30;var ee=0,se=4,ie=8,C=12,ft=16,v=31,D=class{constructor(){this.regs=new Uint8Array(32);this.readregs=new Uint8Array(32);this.shiftregs=new Uint32Array(8);this.count=0;this.an=0;this.rgb=0;this.pmcol=0}reset(){this.regs.fill(0),this.readregs.fill(0),this.readregs[20]=15,this.count=0}saveState(){return u(0,{},this)}loadState(t){u(0,this,t)}setReg(t,e){switch(t){case v:e=e&15^15;break;case te:for(let i=0;i<16;i++)this.readregs[i]=0;return}this.regs[t]=e}readReg(t){return this.readregs[t]}sync(){this.count=0}updateGfx(t,e){switch(t){case 0:this.regs[dt]&1&&(this.regs[lt]=e);break;case 2:case 3:case 4:case 5:this.regs[dt]&2&&(this.regs[ct-2+t]=e);break}}getPlayfieldColor(){switch(this.an){case 0:return Jt;case 4:case 5:case 6:case 7:return qt+this.an-4;case 8:return this.regs[Xt]&240|this.regs[Wt]&15|256}return 256}clockPulse1(){this.processPlayerMissile(),this.clockPulse2(),this.count++}clockPulse2(){var t;if(this.pmcol>=0)t=this.pmcol;else{let e=this.getPlayfieldColor();t=e&256?e&255:this.regs[e]}this.rgb=xt[t]}processPlayerMissile(){let t=-1,e=this.an-4,i=0;for(let a=0;a<4;a++)this.shiftObject(a)&&(e>=0&&(this.readregs[se+a]|=1<<e),i|=1<<a,t=a);this.readregs[C+0]|=i&~1,this.readregs[C+1]|=i&~2,this.readregs[C+2]|=i&~4,this.readregs[C+3]|=i&~8;for(let a=0;a<4;a++)this.shiftObject(a+4)&&(e>=0&&(this.readregs[ee+a]|=1<<e),this.readregs[ie+a]|=i,t=a+4);this.pmcol=t>=0?this.getObjectColor(t):-1}shiftObject(t){let e=(this.shiftregs[t]&2147483648)!=0;return this.shiftregs[t]<<=1,this.regs[Qt+t]-7==this.count&&this.triggerObject(t),e}getObjectColor(t){return this.regs[$t]&16&&t>=4?this.regs[Zt]:this.regs[Gt+(t&3)]}triggerObject(t){let e,i;if(t<4)e=this.regs[jt+t]&3,i=this.regs[ct+t];else{let a=t-4<<1;e=this.regs[zt]>>a&3,i=(this.regs[lt]>>a&3)<<6}e&1?i=mt(i):i<<=8,e==3?i=mt(i):i<<=16,this.shiftregs[t]=i}static stateToLongString(t){let e="";return e+=`X: ${S(t.count,3)}  ANTIC: ${p(t.an,1)}  PM: ${p(t.pmcol,3)}
`,e+=`Write Registers:
`,e+=g(t.regs,0,32),e+=`Read Registers:
`,e+=g(t.readregs,0,32),e}};function mt(r){return r=(r|r<<8)&16711935,r=(r|r<<4)&252645135,r=(r|r<<2)&858993459,r=(r|r<<1)&1431655765,r|r<<1}var xt=new Uint32Array(256);for(I=0;I<256;I++)xt[I]=J(I);var I;var n=0;var re=2;var ut=4;var pt=6;var l=8,ae=9,ne=10,he=11,oe=13,Y=14,y=15;var ce=8,le=9,de=10,fe=13,E=14,K=15;var gt=128,_t=64,me=32,bt=16,yt=8;var xe=1,At=28,ue=114;var Et=511,St=131071,o=0,c=1,d=2,h=3,b=114,pe=15;var ge=8;var B,L;function _e(){B=new Uint8Array(511),L=new Uint8Array(16385);let r=511;for(let t=0;t<511;t++)r=(((r>>5^r)&1)<<8)+(r>>1),B[t]=r;r=131071;for(let t=0;t<16385;t++)r=(((r>>5^r)&255)<<9)+(r>>8),L[t]=r>>1}var k=class{constructor(t,e){this.irq=t;this.antic_xpos=e;this.regs=new Uint8Array(16);this.readregs=new Uint8Array(16);this.divnirq=new Uint32Array(4);this.divnmax=new Uint32Array(4);this.pot_inputs=new Uint8Array(8);this.basemult=0;this.pot_scanline=0;this.random_scanline_counter=0;this.kbcode=0;this.DELAYED_SERIN_IRQ=0;this.DELAYED_SEROUT_IRQ=0;this.DELAYED_XMTDONE_IRQ=0;this.init()}saveState(){return u(0,{},this)}loadState(t){u(0,this,t)}init(){this.readregs.fill(255),this.readregs[K]=239,this.basemult=At,this.pot_inputs.fill(128),_e()}read(t){let e=this.readregs[t];switch(t&=15,t){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:return e=this.pot_inputs[t],e<this.pot_scanline?e:this.pot_scanline;case ce:for(let i=0;i<8;i++)this.pot_inputs[i]<=this.pot_scanline&&(e&=~(1<<i));break;case le:return this.kbcode;case K:e=K+(this.CASSETTE_IOLineStatus()<<4);break;case de:if((this.regs[y]&3)!=0){let i=this.random_scanline_counter+this.antic_xpos();if(this.regs[l]&gt)e=B[i%Et];else{i%=St;let a=i>>3;i&=7,e=(L[a]>>i)+(L[a+1]<<8-i)}}break}return e&255}write(t,e){switch(t&=15,this.regs[t]=e,t){case l:e&xe?this.basemult=ue:this.basemult=At,this.update_counter(1<<o|1<<c|1<<d|1<<h);break;case n:this.update_counter(this.regs[l]&bt?1<<c|1<<o:1<<o);break;case re:this.update_counter(1<<c);break;case ut:this.update_counter(this.regs[l]&yt?1<<h|1<<d:1<<d);break;case pt:this.update_counter(1<<h);break;case Y:this.readregs[E]|=~e&247,~this.readregs[E]&this.regs[Y]&&this.generateIRQ(this.readregs[E]);break;case ne:this.readregs[K]|=224;break;case he:this.regs[y]&4||(this.pot_scanline=0);break;case oe:(this.regs[y]&112)==32&&this.siocheck()&&this.SIO_PutByte(e),(this.regs[y]&8)==0?(this.DELAYED_SEROUT_IRQ=ge,this.readregs[E]|=8,this.DELAYED_XMTDONE_IRQ=pe):(this.DELAYED_SEROUT_IRQ=312*50*10*(this.regs[ut]+this.regs[pt]*256)/895e3,this.DELAYED_SEROUT_IRQ>=3?(this.readregs[E]|=8,this.DELAYED_XMTDONE_IRQ=2*this.DELAYED_SEROUT_IRQ-2):(this.DELAYED_SEROUT_IRQ=0,this.DELAYED_XMTDONE_IRQ=0));break;case ae:this.divnirq[o]=this.divnmax[o],this.divnirq[c]=this.divnmax[c],this.divnirq[d]=this.divnmax[d],this.divnirq[h]=this.divnmax[h];break;case y:e&4&&(this.pot_scanline=228),(e&3)==0&&(this.DELAYED_SERIN_IRQ=0,this.DELAYED_SEROUT_IRQ=0,this.DELAYED_XMTDONE_IRQ=0);break}this.snd_update(t)}update_counter(t){t&1<<o&&(this.regs[l]&_t?this.divnmax[o]=this.regs[n+o]+4:this.divnmax[o]=(this.regs[n+o]+1)*this.basemult,this.divnmax[o]<b&&(this.divnmax[o]=b)),t&1<<c&&(this.regs[l]&bt?this.regs[l]&_t?this.divnmax[c]=this.regs[n+c]*256+this.regs[n+o]+7:this.divnmax[c]=(this.regs[n+c]*256+this.regs[n+o]+1)*this.basemult:this.divnmax[c]=(this.regs[n+c]+1)*this.basemult,this.divnmax[c]<b&&(this.divnmax[c]=b)),t&1<<h&&(this.regs[l]&yt?this.regs[l]&me?this.divnmax[h]=this.regs[n+h]*256+this.regs[n+d]+7:this.divnmax[h]=(this.regs[n+h]*256+this.regs[n+d]+1)*this.basemult:this.divnmax[h]=(this.regs[n+h]+1)*this.basemult,this.divnmax[h]<b&&(this.divnmax[h]=b))}snd_update(t){}advanceScanline(){(this.regs[y]&3)!=0&&(this.pot_scanline<228&&this.pot_scanline++,this.random_scanline_counter+=b,this.random_scanline_counter%=this.regs[l]&gt?Et:St,this.DELAYED_SERIN_IRQ>0&&--this.DELAYED_SERIN_IRQ==0&&(this.readregs[fe]=this.SIO_GetByte(),this.generateIRQ(32)),this.DELAYED_SEROUT_IRQ>0&&--this.DELAYED_SEROUT_IRQ==0&&this.generateIRQ(16),this.DELAYED_XMTDONE_IRQ>0&&--this.DELAYED_XMTDONE_IRQ==0&&this.generateIRQ(8),this.advanceIRQTimer(o,1),this.advanceIRQTimer(c,2),this.advanceIRQTimer(h,4))}advanceIRQTimer(t,e){(this.divnirq[t]-=b)<0&&(this.divnirq[t]+=this.divnmax[t],this.generateIRQ(e))}generateIRQ(t){this.regs[Y]&t&&(this.irq(),this.readregs[E]&=~t)}static stateToLongString(t){let e="";return e+=`Write Registers:
`,e+=g(t.regs,0,16),e+=`Read Registers:
`,e+=g(t.readregs,0,16),e}CASSETTE_IOLineStatus(){return 0}siocheck(){return((this.regs[n+d]==40||this.regs[n+d]==16||this.regs[n+d]==8||this.regs[n+d]==10)&&this.regs[n+h]==0||(this.regs[y]&120)==40)&&(this.regs[l]&40)==40}SIO_PutByte(t){console.log("SIO put byte",t)}SIO_GetByte(){return 0}};var be=[s.VK_L,s.VK_J,s.VK_SEMICOLON,s.VK_F1,s.VK_F2,s.VK_K,s.VK_BACK_SLASH,s.VK_TILDE,s.VK_O,null,s.VK_P,s.VK_U,s.VK_ENTER,s.VK_I,s.VK_MINUS,s.VK_EQUALS,s.VK_V,s.VK_F8,s.VK_C,s.VK_F3,s.VK_F4,s.VK_B,s.VK_X,s.VK_Z,s.VK_4,null,s.VK_3,s.VK_6,s.VK_ESCAPE,s.VK_5,s.VK_2,s.VK_1,s.VK_COMMA,s.VK_SPACE,s.VK_PERIOD,s.VK_N,null,s.VK_M,s.VK_SLASH,null,s.VK_R,null,s.VK_E,s.VK_Y,s.VK_TAB,s.VK_T,s.VK_W,s.VK_Q,s.VK_9,null,s.VK_0,s.VK_7,s.VK_BACK_SPACE,s.VK_8,s.VK_LEFT,s.VK_RIGHT,s.VK_F,s.VK_H,s.VK_D,null,s.VK_CAPS_LOCK,s.VK_G,s.VK_S,s.VK_A],ye=O([[s.UP,0,1],[s.DOWN,0,2],[s.LEFT,0,4],[s.RIGHT,0,8],[s.VK_SHIFT,2,1],[s.START,3,1],[s.SELECT,3,2],[s.VK_F6,3,4]]),w=class extends et{constructor(){super();this.cpuFrequency=1789773;this.numTotalScanlines=262;this.cpuCyclesPerLine=114;this.canvasWidth=352;this.aspectRatio=240/172;this.firstVisibleClock=36*2;this.numVisibleScanlines=250;this.defaultROMSize=32768;this.overscan=!0;this.audioOversample=4;this.sampleRate=this.numTotalScanlines*60*this.audioOversample;this.inputs=new Uint8Array(4);this.linergb=new Uint32Array(this.canvasWidth);this.lastdmabyte=0;this.keycode=0;this.cart_80=!1;this.cart_a0=!1;this.cpu=new it,this.ram=new Uint8Array(65536),this.bios=new Uint8Array(10240),this.bus=this.newBus(),this.connectCPUMemoryBus(this.bus),this.antic=new T(this.readDMA.bind(this),this.antic_nmi.bind(this)),this.gtia=new D,this.irq_pokey=new k(this.pokey_irq.bind(this),()=>this.antic.h),this.audio_pokey=$(1),this.audioadapter=new tt(this.audio_pokey.pokey1,this.audioOversample,this.sampleRate),this.handler=Z(this.inputs,ye,this.getKeyboardFunction(),!0)}newBus(){return{read:R([[0,32767,65535,t=>this.ram[t]],[32768,40959,65535,t=>this.cart_80?this.rom[t-32768]:this.ram[t]],[40960,49151,65535,t=>this.cart_a0?this.rom[t-32768]:this.ram[t]],[53248,53503,31,t=>this.gtia.readReg(t)],[53760,54015,15,t=>this.readPokey(t)],[54016,54271,15,t=>this.readPIA(t)],[54272,54527,15,t=>this.antic.readReg(t)],[55296,65535,65535,t=>this.bios[t-55296]]]),write:R([[0,49151,65535,(t,e)=>{this.ram[t]=e}],[53248,53503,31,(t,e)=>{this.gtia.setReg(t,e)}],[53760,54015,15,(t,e)=>{this.writePokey(t,e)}],[54272,54527,15,(t,e)=>{this.antic.setReg(t,e)}]])}}loadBIOS(t){this.bios.set(t)}reset(){console.log(this.saveState()),super.reset(),this.antic.reset(),this.gtia.reset(),this.keycode=0}read(t){return this.bus.read(t)}readDMA(t){let e=this.bus.read(t);return this.probe.logVRAMRead(t,e),this.lastdmabyte=e,e}readConst(t){return t<53248||t>=57344?this.bus.read(t):255}write(t,e){this.bus.write(t,e)}readPokey(t){switch(t&15){case 9:return this.keycode&255;case 15:return~this.keycode>>6&4|~this.keycode>>3&8|18;default:return this.irq_pokey.read(t)}}readPIA(t){if(t==0||t==1)return~this.inputs[t]}writePokey(t,e){this.audio_pokey.pokey1.setRegister(t,e),this.irq_pokey.write(t,e)}startScanline(){this.gtia.sync();for(let t=0;t<4;t++)this.gtia.readregs[ft+t]=~this.inputs[2]>>t&1;this.gtia.readregs[v]=~this.inputs[3]&this.gtia.regs[v],this.audio&&this.audioadapter.generate(this.audio),this.irq_pokey.advanceScanline()}drawScanline(){this.antic.v<this.numVisibleScanlines&&this.pixels.set(this.linergb,this.antic.v*this.canvasWidth)}advanceCPU(){this.antic.clockPulse()?(this.gtia.updateGfx(this.antic.h-1,this.lastdmabyte),this.probe.logClocks(1)):super.advanceCPU();let t=()=>{this.gtia.clockPulse1(),this.linergb[i++]=this.gtia.rgb},e=()=>{this.gtia.clockPulse2(),this.linergb[i++]=this.gtia.rgb},i=this.antic.h*4-this.firstVisibleClock,a=ot[this.antic.mode];return(a<8||(i&4)==0)&&(this.gtia.an=this.antic.shiftout()),t(),a==1&&(this.gtia.an=this.antic.shiftout()),e(),a<=2&&(this.gtia.an=this.antic.shiftout()),t(),a==1&&(this.gtia.an=this.antic.shiftout()),e(),1}loadState(t){this.cpu.loadState(t.c),this.ram.set(t.ram),this.antic.loadState(t.antic),this.gtia.loadState(t.gtia),this.irq_pokey.loadState(t.pokey),this.loadControlsState(t),this.lastdmabyte=t.lastdmabyte,this.keycode=t.keycode}saveState(){return{c:this.cpu.saveState(),ram:this.ram.slice(0),antic:this.antic.saveState(),gtia:this.gtia.saveState(),pokey:this.irq_pokey.saveState(),inputs:this.inputs.slice(0),lastdmabyte:this.lastdmabyte,keycode:this.keycode}}loadControlsState(t){this.inputs.set(t.inputs)}saveControlsState(){return{inputs:this.inputs.slice(0)}}getRasterScanline(){return this.antic.v}getDebugCategories(){return["CPU","Stack","ANTIC","GTIA","POKEY"]}getDebugInfo(t,e){switch(t){case"ANTIC":return T.stateToLongString(e.antic);case"GTIA":return D.stateToLongString(e.gtia);case"POKEY":return k.stateToLongString(e.pokey)}}getKeyboardFunction(){return(t,e,i,a)=>{if(a&(f.KeyDown|f.KeyUp)){var m=be;if(e==s.VK_F9.c)return this.irq_pokey.generateIRQ(128),!0;for(var x=0;x<m.length;x++)if(m[x]&&m[x].c==e&&(this.keycode=x,a&f.Shift&&(this.keycode|=64),a&f.Ctrl&&(this.keycode|=128),a&f.KeyDown))return this.keycode|=256,this.irq_pokey.generateIRQ(64),console.log(t,e,i,a,p(this.keycode)),!0}}}pokey_irq(){this.cpu.IRQ(),this.probe.logInterrupt(2)}antic_nmi(){this.cpu.NMI(),this.probe.logInterrupt(1)}loadROM(t){let e=new Uint8Array(32768);for(let i=0;i<=e.length-t.length;i+=t.length)e.set(t,i);this.cart_a0=!0,t.length==16384&&(this.cart_80=!0),super.loadROM(e)}},H=class extends w{newBus(){return{read:R([[0,16383,65535,t=>this.ram[t]],[16384,49151,65535,t=>this.rom?this.rom[t-16384]:0],[49152,53247,31,t=>this.gtia.readReg(t)],[54272,54527,15,t=>this.antic.readReg(t)],[59392,61439,15,t=>this.readPokey(t)],[63488,65535,2047,t=>this.bios[t]]]),write:R([[0,16383,65535,(t,e)=>{this.ram[t]=e}],[49152,53247,31,(t,e)=>{this.gtia.setReg(t,e)}],[54272,54527,15,(t,e)=>{this.antic.setReg(t,e)}],[59392,61439,15,(t,e)=>{this.writePokey(t,e)}]])}}},Q=class extends st{constructor(){super(...arguments);this.numTotalScanlines=312;this.cpuCyclesPerLine=63;this.joymask0=0;this.joymask1=0}loadROM(t){super.loadROM(t),this.reloadROM()}reloadROM(){if(this.sys){var t=this.exports.machine_load_rom(this.sys,this.romptr,this.romlen);console.log("machine_load_rom",t)}}loadBIOS(t){super.loadBIOS(t)}reset(){this.reloadROM()}advanceFrame(t){return this.exports.machine_start_frame(this.sys),t?this.advanceFrameClock(t,999999):this.exports.machine_advance_frame(this.sys),this.syncVideo(),this.syncAudio(),1}getCPUState(){this.exports.machine_save_cpu_state(this.sys,this.stateptr);var t=this.statearr,e=t[6]+(t[7]<<8);return{PC:e,SP:t[2],A:t[0],X:t[3],Y:t[4],C:t[1]&1,Z:t[1]&2,I:t[1]&4,D:t[1]&8,V:t[1]&64,N:t[1]&128,o:this.readConst(e)}}saveState(){var t=this.getCPUState();return this.exports.machine_save_state(this.sys,this.stateptr),{c:t,state:this.statearr.slice(0)}}loadState(t){this.statearr.set(t.state),this.exports.machine_load_state(this.sys,this.stateptr)}getVideoParams(){return{width:384,height:240,overscan:!0,videoFrequency:60}}pollControls(){}setKeyInput(t,e,i){i&f.Shift&&(t|=256),i&f.Ctrl&&(t|=512);var a=0;t==37&&(t=8,a=4),t==38&&(t=11,a=1),t==39&&(t=9,a=8),t==40&&(t=10,a=2),t==32&&(a=256),i&f.KeyDown?(this.exports.machine_key_down(this.sys,t),this.joymask0|=a):i&f.KeyUp&&(this.exports.machine_key_up(this.sys,t),this.joymask0&=~a),this.setJoyInput(0,this.joymask0),this.setJoyInput(1,this.joymask1)}setJoyInput(t,e){this.exports.machine_joy_set(this.sys,t,e)}setPaddleInput(t,e){this.exports.machine_paddle_set(this.sys,t,e)}};var Rt=[{id:"hello.dasm",name:"Hello World (ASM)"},{id:"hellopm.dasm",name:"Hello Sprites (ASM)"},{id:"helloconio.c",name:"Text Mode (C)"},{id:"siegegame.c",name:"Siege Game (C)"},{id:"hellodlist.c",name:"Display List (C)"}],j=Rt.concat([{id:"sieve.bas",name:"Benchmark (FastBasic)"},{id:"pmtest.bas",name:"Sprites Test (FastBasic)"},{id:"dli.bas",name:"DLI Test (FastBasic)"},{id:"joyas.bas",name:"Match-3 Game (FastBasic)"}]),os=O([[s.VK_SPACE,0,0],[s.VK_ENTER,0,0]]),z={main:[{name:"RAM",start:0,size:49152,type:"ram"},{name:"Left Cartridge ROM",start:40960,size:8192,type:"rom"},{name:"GTIA",start:53248,size:32,type:"io"},{name:"POKEY",start:53760,size:16,type:"io"},{name:"PIA",start:54016,size:4,type:"io"},{name:"ANTIC",start:54272,size:16,type:"io"},{name:"Cartridge Control Line",start:54784,size:256,type:"io"},{name:"ROM",start:55296,size:2048,type:"rom"},{name:"Character Set",start:57344,size:1024,type:"rom"},{name:"ROM",start:58368,size:7168,type:"rom"}]};function G(r){return r.endsWith(".bas")||r.endsWith(".fb")||r.endsWith(".fbi")?"fastbasic":rt(r)}var q=class extends nt{constructor(){super(...arguments);this.getToolForFilename=G;this.getOpcodeMetadata=at}getPresets(){return Rt}getDefaultExtension(){return".asm"}showHelp(t,e){t=="fastbasic"?window.open("https://github.com/dmsc/fastbasic/blob/master/manual.md","_help"):window.open("https://atariwiki.org/wiki/Wiki.jsp?page=Assembler","_help")}};var It=class extends q{constructor(){super(...arguments);this.getMemoryMap=function(){return z}}getPresets(){return j}loadROM(t,e){this.started?(this.loadROMFile(e),this.loadRegion(":cartleft:cart:rom",e)):this.startModule(this.mainElement,{jsfile:"mame8bitws.js",biosfile:"a800xl.zip",cfgfile:"a800xl.cfg",driver:"a800xl",width:336*2,height:225*2,romfn:"/emulator/cart.rom",romdata:new Uint8Array(e),romsize:8192,preInit:function(i){}})}start(){}},Ot=class extends q{constructor(){super(...arguments);this.getMemoryMap=function(){return{main:[{name:"RAM",start:0,size:16384,type:"ram"},{name:"Cartridge ROM",start:16384,size:32768,type:"rom"},{name:"GTIA",start:49152,size:32,type:"io"},{name:"ANTIC",start:54272,size:16,type:"io"},{name:"POKEY",start:59392,size:16,type:"io"},{name:"ATARI Character Set",start:63488,size:1024,type:"rom"},{name:"ROM",start:64512,size:1024,type:"rom"}]}}}loadROM(t,e){this.started?(this.loadROMFile(e),this.loadRegion(":cartleft:cart:rom",e)):this.startModule(this.mainElement,{jsfile:"mame8bitws.js",biosfile:"a5200/5200.rom",cfgfile:"a5200.cfg",driver:"a5200",width:336*2,height:225*2,romfn:"/emulator/cart.rom",romdata:new Uint8Array(e),romsize:32768,preInit:function(i){}})}start(){}},Mt=class extends F{constructor(){super(...arguments);this.getToolForFilename=G}newMachine(){return new Q("atari8")}getPresets(){return j}getDefaultExtension(){return".c"}readAddress(t){return this.machine.readConst(t)}getMemoryMap(){return z}showHelp(){}getROMExtension(t){return t&&t[0]==1&&t[1]==8?".prg":".bin"}},Pt=class extends Mt{},W=class extends F{constructor(){super(...arguments);this.getToolForFilename=G;this.biosPath="res/altirra/kernel.rom"}newMachine(){return new w}getPresets(){return j}getDefaultExtension(){return".c"}readAddress(t){return this.machine.readConst(t)}getMemoryMap(){return z}showHelp(){}getROMExtension(t){return t&&t[0]==1&&t[1]==8?".prg":".bin"}async start(){let t=await this.loadKernel();await super.start(),this.machine.loadBIOS(t)}async loadKernel(){var t=await fetch(this.biosPath);if(t.status==200||t.size){var e=await t.arrayBuffer();return new Uint8Array(e)}else throw new Error("could not load BIOS file")}},Tt=class extends W{constructor(){super(...arguments);this.biosPath="res/altirra/superkernel.rom"}newMachine(){return new H}};A["atari8-800.xlmame"]=It;A["atari8-5200.mame"]=Ot;A["atari8-800.xlwasm"]=Pt;A["atari8-800"]=W;A["atari8-5200"]=Tt;
//# sourceMappingURL=atari8-3V22L5XH.js.map
